import React from 'react';

import Store, { useStore, Provider } from 'store/context';
import * as pages from 'components/pages/index';
import { isDev } from 'config/public';

function MainRouter() {
  const { data, state } = React.useContext(Store);
  const currentRouteId = state('currentRouteId');

  let Component;
  try {
    const { component } = data.routesData[currentRouteId];
    Component = pages[component];
    if (!Component) {
      throw Error('Bad path data');
    }
  } catch (err) {
    console.error(err); // TODO: Log to monitoring service
    document.location.href = '/?s=500';
  }

  return (
    <div id="app">
      <a className="skip-link" href="#main-content">
        Skip to main
      </a>
      {isDev && <div className="dev-badge">DEV</div>}
      <div id="general-wrapper" className="p-10">
        <Component />
      </div>
    </div>
  );
}

export default function Root({ initState, gData }) {
  const store = useStore(initState, gData);

  React.useEffect(() => {
    window.onpopstate = store.historyHandler;
    return () => {
      window.onpopstate = void 0;
    };
  }, [store.historyHandler]);

  return (
    <Provider value={store}>
      <MainRouter />
    </Provider>
  );
}
