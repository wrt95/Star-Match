import path from 'path';
import express from 'express';
import bodyParser from 'body-parser';
import cookieSession from 'cookie-session';
import serialize from 'serialize-javascript';
import helmet from 'helmet';

import 'config/check';
import * as config from 'config/private';
import { requestLogger, errorLogger } from './logger';
import mainRouter from './routers';

const startServer = async () => {
  const app = express();
  if (config.isDev) {
    // Static assets should not be served with Node in production
    app.use('/sf', express.static('public'));
  }
  app.set('trust proxy', 1);
  app.use(helmet());
  app.set('view engine', 'ejs');
  app.set('views', path.resolve(__dirname, './views'));
  app.use(
    cookieSession({
      name: 'session',
      keys: config.keys,
      secure: !config.isDev,
      maxAge: 7 * 24 * 60 * 60 * 1000,
    }),
  );
  app.use(bodyParser.urlencoded({ extended: false }));
  app.use(bodyParser.json());

  app.locals.serialize = serialize;
  if (config.isDev) {
    app.locals.gVars = {
      main: ['main.css', 'main.js'],
      vendor: 'vendor.js',
    };
  } else {
    try {
      app.locals.gVars = require('../../.reactful.json');
    } catch (err) {
      console.error('Reactful did not find Webpack generated assets');
    }
  }

  app.use(requestLogger);
  app.use('/', mainRouter);
  app.use(errorLogger);

  app.listen(config.port, config.host, () => {
    console.info(`Server is running on ${config.host}:${config.port}`);
  });
};

startServer();
